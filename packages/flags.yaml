flags:
  input_number:
    batt_threshold_display_cell:
      name: Threshold of Cell Battery to Display
      mode: box
      min: 40
      max: 100
    batt_threshold_display_tablet:
      name: Threshold of Tablet Battery to Display
      mode: box
      min: 40
      max: 100
    batt_threshold_display_kindle_fire_hd8:
      name: Threshold of Kindle Fire HD8 Battery to Display
      mode: box
      min: 40
      max: 100
    batt_threshold_display_zte:
      name: Threshold of ZTE Battery to Display
      mode: box
      min: 40
      max: 100
    batt_threshold_window_sensors:
      name: Threshold of Window Sensor Batteries to Display
      mode: box
      min: 10
      max: 100
    dawn_shift_minutes:
      name: Num Mins after Sunrise to also consider Twilight
      mode: box
      min: 0
      max: 120
    dusk_shift_minutes:
      name: Num Mins Before Sunset to also consider Twilight
      mode: box
      min: 0
      max: 120

  input_datetime:
    morning_automations_after:
      name: "Morning Automations After"
      has_date: false
      has_time: true
    evening_automations_until:
      name: "Evening Automations Until"
      has_date: false
      has_time: true

  binary_sensor:
    - platform: template
      sensors:
        bedroom_tv_on:
          friendly_name: MBR TV On
          value_template: >
            {% if states("sensor.neo_green_1_bedroom_tv_electric_consumed_w") | float > 30 %}
              True
            {% else %}
              False
            {% endif %}
        family_room_tv_on:
          friendly_name: Family Room TV On
          value_template: >
            {% set fam_tv_state = states('sensor.harmony_family_room_status') %}
            {% if (fam_tv_state == "Watch TiVo" or fam_tv_state == "Watch Chromecast" or fam_tv_state == "Watch a Blue-ray") %}
              True
            {% else %}
              False
            {% endif %}
        any_tv_on:
          friendly_name: Any TV On
          value_template: >
            {% if is_state('binary_sensor.bedroom_tv_on','on') or is_state('binary_sensor.family_room_tv_on','on') %}
              True
            {% else %}
              False
            {% endif %}

        any_google_home_alarm_timer_set:
          friendly_name: Any Google Home Alarms Set
          value_template: >
            {% if is_state('sensor.family_room_home_alarms','unavailable')
              and is_state('sensor.family_room_home_timers','unavailable')
              and is_state('sensor.bedroom_home_alarms','unavailable')
              and is_state('sensor.bedroom_home_timers','unavailable')
              and is_state('sensor.office_home_alarms','unavailable')
              and is_state('sensor.office_home_timers','unavailable')
            %}
              False
            {% else %}
              True
            {% endif %}

        tablet_battery_below_threshold:
          friendly_name: Tablet Battery Below Threshold
          value_template: >
            {% if states('sensor.davids_tablet_battery_level') | int < states('input_number.batt_threshold_display_tablet') | int %}
              True
            {% else %}
              False
            {% endif %}
        davids_cell_battery_below_threshold:
          friendly_name: Cell Battery Below Threshold
          value_template: >
            {% if states('sensor.davids_cell_battery_level') | int < states('input_number.batt_threshold_display_cell') | int %}
              True
            {% else %}
              False
            {% endif %}
        kindle_fire_hd8_battery_below_threshold:
          friendly_name: Kindle Fire HD8 Battery Below Threshold
          value_template: >
            {% if (states('sensor.kindle_fire_hd8_battery_level') | int < states('input_number.batt_threshold_display_kindle_fire_hd8') | int) and not is_state('sensor.kindle_fire_hd8_battery_level','unknown') %}
              True
            {% else %}
              False
            {% endif %}
        zte_axon_battery_below_threshold:
          friendly_name: ZTE Phone Battery Below Threshold
          value_template: >
            {% if states('sensor.zte_axon_battery_level') | int < states('input_number.batt_threshold_display_zte') | int %}
              True
            {% else %}
              False
            {% endif %}



        #
        # Order in the day:
        #     Dawn, then Rising
        #     Setting, then Dusk
        #
        is_morning_dark:
          friendly_name: Is Dark thru Dawn to Sunrise
          value_template: >
            {% if
                ( (state_attr('sun.sun','next_rising') | as_timestamp() ) < (state_attr('sun.sun','next_midnight') | as_timestamp() ) )
              and
                ( now().strftime("%H:%M:%S") >= states('input_datetime.morning_automations_after') )
              and
                ( (now() | as_timestamp()) <= (state_attr('sun.sun','next_rising') | as_timestamp()) )
            %}
                True
            {% else %}
                False
            {% endif %}

        is_morning_after_sunrise:
          friendly_name: Is Just after Sunrise
          value_template: >
            {% if
                ( (state_attr('sun.sun','next_setting') | as_timestamp() ) < (state_attr('sun.sun','next_midnight') | as_timestamp() ) )
              and
                ( (state_attr('sun.sun','next_rising') | as_timestamp())
                > (state_attr('sun.sun','next_midnight') | as_timestamp() )
                )
              and
                ( (now() | as_timestamp()) <= ((state_attr('sun.sun','next_rising')  | as_timestamp() | int) - 86400 + (states('input_number.dawn_shift_minutes')|int * 60)) )
            %}
                True
            {% else %}
                False
            {% endif %}

        is_morning_dark_or_dawn_or_sunrise:
          friendly_name: Is Dark thru Just after Sunrise
          value_template: >
            {% if is_state('binary_sensor.is_morning_dark','on') or is_state('binary_sensor.is_morning_after_sunrise','on') %}
                True
            {% else %}
                False
            {% endif %}


        is_evening_before_sunset:
          friendly_name: Is Just before Sunset
          value_template: >
            {% if
                ( (state_attr('sun.sun','next_dusk') | as_timestamp() ) < (state_attr('sun.sun','next_midnight') | as_timestamp() ))
              and
                ( (now() | as_timestamp()) >= ((state_attr('sun.sun','next_setting') | as_timestamp() | int) - (states('input_number.dusk_shift_minutes')|int * 60)) )
              and
                ( (now() | as_timestamp()) <= (state_attr('sun.sun','next_setting') | as_timestamp()) )
            %}
                True
            {% else %}
                False
            {% endif %}

        is_evening_dark:
          friendly_name: Is Sunset thru Dusk to Dark
                # ( (now() | as_timestamp()) <= (state_attr('sun.sun','next_dusk') | as_timestamp()) )
          value_template: >
            {% if
                ( (state_attr('sun.sun','next_setting') | as_timestamp() ) > (state_attr('sun.sun','next_midnight') | as_timestamp() ) )
              and
                ( now().strftime("%H:%M:%S") < states('input_datetime.evening_automations_until') )
            %}
                True
            {% else %}
                False
            {% endif %}

        is_evening_sunset_or_dusk_or_dark:
          friendly_name: Is Sunset or after (Dusk + Dark)
          value_template: >
            {% if is_state('binary_sensor.is_evening_before_sunset','on') or is_state('binary_sensor.is_evening_dark','on') %}
                True
            {% else %}
                False
            {% endif %}
